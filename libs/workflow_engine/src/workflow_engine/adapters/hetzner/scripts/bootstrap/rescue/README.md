# Rescue Mode Module

This module handles rescue mode password generation, persistence, and tenant repository integration during the bootstrap process.

## Overview

When bootstrapping a Hetzner bare-metal server, the system must:
1. Enable rescue mode via Hetzner API
2. Generate a secure root password
3. Persist the password locally and in the tenant repository
4. Initialize tenant repository structure if missing
5. Reboot the server into rescue mode

## Architecture

### Components

**rescue_password_provider.py**
- Python class for password persistence
- Saves to local cache (`.zerotouch-cache/rescue-password.txt`)
- Saves to tenant repository (`environments/{env}/talos-values.yaml`)
- Auto-initializes tenant structure if missing
- Handles git commit and push operations

**talos-values.yaml.j2**
- Jinja2 template for tenant repository configuration
- Contains cluster, node, and rescue password configuration
- Rendered with values from bootstrap context

**init-tenant-structure.sh**
- Bash script to initialize missing tenant repository structure
- Creates `environments/{env}/` directory
- Renders Jinja2 template with cluster values
- Commits initial configuration to git

## Workflow

### 1. Rescue Mode Activation
The main bootstrap script (`01-enable-rescue-mode.sh`) calls Hetzner API to enable rescue mode and generate a root password.

### 2. Password Persistence
The `RescuePasswordProvider` class:
- Saves password to local cache for later stages
- Checks if tenant repository structure exists
- If missing, calls `init-tenant-structure.sh` to create it
- If exists, updates the password field using `yq`
- Commits changes via `update-tenant-config.sh`

### 3. Tenant Repository Structure
```
tenant-repo/
├── environments/
│   ├── dev/
│   │   └── talos-values.yaml
│   ├── staging/
│   │   └── talos-values.yaml
│   └── prod/
│       └── talos-values.yaml
└── README.md
```

Each environment has its own configuration with:
- Control plane node details (name, IP, rescue password)
- Worker node configurations
- Cluster settings (name, subnets, DNS domain)
- Talos and Kubernetes versions

### 4. Template Rendering
The Jinja2 template receives values from bootstrap context:
- `env` - Environment name (dev/staging/prod)
- `cluster_name` - Cluster identifier
- `controlplane_name` - Control plane node name
- `controlplane_ip` - Control plane IP address
- `rescue_password` - Generated root password
- `talos_version` - Talos OS version

### 5. Git Integration
Changes are automatically committed and pushed to the tenant repository:
- Initial structure creation: "Initialize {env} environment with rescue password"
- Password updates: "Update rescue password ({env})"

## Error Handling

### Missing yq
If `yq` is not installed, the provider logs a warning and skips tenant repository updates. The password is still saved to local cache.

### Missing Tenant Repository
If the tenant repository is not cloned or accessible, the provider logs a warning and continues. The password is saved to local cache only.

### Git Conflicts
If there are uncommitted changes or conflicts, the `update-tenant-config.sh` script will fail gracefully. The bootstrap process continues with the locally cached password.

## Security

### Password Storage
- Local cache file has `0600` permissions (owner read/write only)
- Tenant repository is private and requires GitHub App authentication
- Passwords are never logged to stdout (only stderr for debugging)

### Password Generation
Passwords are generated by Hetzner API using cryptographically secure random generation.

## Integration Points

### Bootstrap Context
The rescue mode script reads from `ZTC_CONTEXT_FILE`:
- `cluster_name` - Cluster identifier
- `nodes[0].name` - Control plane node name
- `nodes[0].ip` - Control plane IP
- `nodes[0].talos_version` - Talos version
- `env` - Target environment

### Helper Scripts
- `helpers/fetch-tenant-config.sh` - Clones/updates tenant repository
- `helpers/update-tenant-config.sh` - Commits and pushes changes
- `helpers/hetzner-api.sh` - Hetzner API functions

### Subsequent Stages
Later bootstrap stages read the rescue password from:
1. Local cache (`.zerotouch-cache/rescue-password.txt`)
2. Tenant repository (if local cache is missing)

## Debugging

### Check Password Locations
```bash
# Local cache
cat .zerotouch-cache/rescue-password.txt

# Tenant repository
cat .zerotouch-cache/tenants-cache/environments/dev/talos-values.yaml
```

### Verify Tenant Structure
```bash
# Check if structure exists
ls -la .zerotouch-cache/tenants-cache/environments/

# Check git history
cd .zerotouch-cache/tenants-cache
git log --oneline
```

### Manual Initialization
```bash
# Initialize structure manually
bash libs/workflow_engine/src/workflow_engine/adapters/hetzner/scripts/bootstrap/rescue/init-tenant-structure.sh \
  .zerotouch-cache/tenants-cache \
  dev \
  "test-password" \
  "my-cluster" \
  "cp01" \
  "192.168.1.1" \
  "v1.11.5"
```

## Design Decisions

### Why Jinja2 Instead of sed?
Jinja2 provides:
- Type safety and validation
- Consistent template syntax across the project
- Better error messages for missing variables
- Easier to extend with filters and logic

### Why Auto-Initialize?
The tenant repository may be empty on first bootstrap. Auto-initialization:
- Reduces manual setup steps
- Ensures consistent structure across environments
- Provides a working baseline configuration
- Commits initial state for audit trail

### Why Both Local and Remote Storage?
- **Local cache**: Fast access for subsequent bootstrap stages
- **Tenant repository**: Persistent storage, team access, audit trail
- **Fallback**: If one fails, the other provides redundancy

### Why Modular Structure?
Separating rescue mode logic into its own module:
- Improves code organization and maintainability
- Makes testing easier (isolated components)
- Allows reuse in other contexts
- Follows single responsibility principle
