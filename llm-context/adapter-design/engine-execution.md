# ZTC Engine Execution Flow

## Overview

The ZTC engine orchestrates platform deployment through four distinct commands, each with a specific responsibility. Understanding the separation between **configuration-time** (`ztc render`) and **execution-time** (`ztc bootstrap`) is critical for adapter design.

---

## 1. Init Workflow (`ztc init`)

**Purpose:** Interactive configuration collection and validation.

```
ztc init
├─ Discover available adapters from registry
├─ User selects adapters (e.g., Hetzner, Talos, KSOPS)
├─ Collect adapter-specific inputs via get_required_inputs()
├─ Validate configuration using Pydantic models
└─ Write platform.yaml with adapter configurations
```

**Key Points:**
- No scripts execute
- No infrastructure provisioned
- Only configuration validation occurs
- Output: `platform.yaml`

---

## 2. Render Pipeline (`ztc render`)

**Purpose:** Generate static artifacts and manifests from configuration. **NO SCRIPTS EXECUTE.**

```
ztc render
├─ Load platform.yaml
├─ Resolve adapter dependencies (topological sort by capabilities)
├─ Execute adapter.render() methods in dependency order:
│  ├─ Adapter A.render() → generates manifests, provides capabilities
│  ├─ Adapter B.render() → consumes capabilities, generates manifests
│  └─ Adapter C.render() → consumes capabilities, generates manifests
├─ Collect all manifests and write to platform/generated/
├─ Generate pipeline.yaml (script execution plan for bootstrap)
└─ Create platform/lock.json with artifact hashes
```

**What Happens in `render()`:**
- Adapters generate **static templates/manifests** (YAML, JSON, etc.)
- Adapters declare **capability contracts** (what they provide/require)
- Adapters return **script references** (not executed, just cataloged)
- Templates may contain **placeholders** for values generated during bootstrap
- Output written to `platform/generated/` directory

**What Does NOT Happen:**
- ❌ No scripts execute
- ❌ No infrastructure provisioned
- ❌ No API calls to cloud providers
- ❌ No cluster operations
- ❌ No dynamic values generated (e.g., Age keys, certificates)

**Critical Design Rule:**
> `render()` must be **idempotent** and **side-effect free**. It only generates files based on `platform.yaml` configuration. Any dynamic values (keys, tokens, IDs) are generated during `ztc bootstrap`, not `ztc render`.

---

## 3. Bootstrap Execution (`ztc bootstrap`)

**Purpose:** Execute the deployment pipeline. **ALL SCRIPTS RUN HERE.**

```
ztc bootstrap
├─ Validate platform/lock.json integrity
├─ Load pipeline.yaml (generated by render)
├─ Extract embedded scripts to secure temp directory (ztc-secure-*)
├─ Generate context JSON files for each script
├─ Execute stage-executor.sh with pipeline.yaml
│  │
│  ├─ STAGE 1: Pre-Work Scripts
│  │  ├─ Execute adapter.pre_work_scripts() in sequence
│  │  ├─ Example: enable-rescue-mode.sh, configure-networking.sh
│  │  └─ Purpose: Prepare environment before main provisioning
│  │
│  ├─ STAGE 2: Bootstrap Scripts
│  │  ├─ Execute adapter.bootstrap_scripts() in sequence
│  │  ├─ Example: install-talos.sh, generate-age-keys.sh, deploy-ksops.sh
│  │  └─ Purpose: Core infrastructure provisioning
│  │
│  ├─ STAGE 3: Post-Work Scripts
│  │  ├─ Execute adapter.post_work_scripts() in sequence
│  │  ├─ Example: wait-for-pods.sh, configure-dns.sh
│  │  └─ Purpose: Finalization and readiness checks
│  │
│  └─ STAGE 4: Validation Scripts
│     ├─ Execute adapter.validation_scripts() in sequence
│     ├─ Example: validate-cluster.sh, validate-secrets.sh
│     └─ Purpose: Verify deployment correctness
│
└─ Cleanup secure temp directory
```

**Script Execution Details:**
- Each script receives a **context JSON file** via `$ZTC_CONTEXT_FILE` environment variable
- Secrets passed via **environment variables** (never in JSON files)
- Scripts execute with **timeouts** specified in ScriptReference
- Failed scripts halt pipeline execution
- Stage completion cached to support resume

**What Happens During Bootstrap:**
- ✅ Scripts execute in secure temp directory
- ✅ Infrastructure provisioned (VMs, clusters, storage)
- ✅ Dynamic values generated (keys, certificates, tokens)
- ✅ API calls to cloud providers
- ✅ Cluster operations (kubectl, helm)
- ✅ Secrets encrypted and stored

---

## 4. Validation (`ztc validate`)

**Purpose:** Verify generated artifacts match configuration (drift detection).

```
ztc validate
├─ Load platform/lock.json
├─ Re-render manifests from platform.yaml
├─ Compare artifact hashes
├─ Detect configuration drift
└─ Report discrepancies
```

**Key Points:**
- No scripts execute
- No infrastructure changes
- Only validates render output consistency

---

## Adapter Lifecycle Method Responsibilities

| Method | Executes During | Purpose | Can Execute Scripts? | Can Generate Dynamic Values? |
|--------|----------------|---------|---------------------|----------------------------|
| `get_required_inputs()` | `ztc init` | Define configuration prompts | ❌ No | ❌ No |
| `render()` | `ztc render` | Generate static manifests/templates | ❌ No | ❌ No |
| `pre_work_scripts()` | `ztc bootstrap` | Return script references for pre-work stage | ❌ No (returns references) | ❌ No |
| `bootstrap_scripts()` | `ztc bootstrap` | Return script references for bootstrap stage | ❌ No (returns references) | ❌ No |
| `post_work_scripts()` | `ztc bootstrap` | Return script references for post-work stage | ❌ No (returns references) | ❌ No |
| `validation_scripts()` | `ztc bootstrap` | Return script references for validation stage | ❌ No (returns references) | ❌ No |
| `check_health()` | `ztc bootstrap` (pre-flight) | Validate prerequisites before execution | ✅ Yes (API calls allowed) | ❌ No |

**Note:** Script reference methods (`*_scripts()`) are called during `render()` to build the pipeline, but the actual scripts execute during `ztc bootstrap`.

---

## Common Adapter Design Patterns

### Pattern 1: Template Generation in `render()`, Population in `bootstrap`

**Use Case:** Secrets management where encryption keys are generated during bootstrap.

```python
# In render()
def render(self, ctx):
    # Generate .sops.yaml TEMPLATE with placeholder
    template = """
    creation_rules:
      - path_regex: .*\.yaml$
        age: {{ age_public_key }}
        encrypted_regex: '^(data|stringData)'
    """
    return AdapterOutput(manifests={"sops-config": template})

# In bootstrap_scripts()
def bootstrap_scripts(self):
    return [
        ScriptReference(
            resource="generate-age-keys.sh",
            description="Generate Age keypair and populate .sops.yaml"
        )
    ]
```

**Execution Flow:**
1. `ztc render` → generates `.sops.yaml` template with placeholder
2. `ztc bootstrap` → runs `generate-age-keys.sh` which replaces placeholder with actual key

### Pattern 2: Capability Contracts Without Dynamic Values

**Use Case:** Providing metadata about infrastructure without needing runtime values.

```python
def render(self, ctx):
    # Provide capability contract with static configuration
    capability = SecretsManagementCapability(
        provider="ksops",
        s3_bucket=self.config["s3_bucket_name"],
        sops_config_path=".sops.yaml"
        # Note: age_public_key NOT included - generated during bootstrap
    )
    return AdapterOutput(capabilities={"secrets-management": capability})
```

### Pattern 3: Pre-Flight Validation in `check_health()`

**Use Case:** Verify cloud provider credentials before bootstrap.

```python
def check_health(self):
    import boto3  # Localized import
    
    client = boto3.client('s3', ...)
    client.head_bucket(Bucket=self.config["bucket_name"])
    # Raises PreFlightError if bucket doesn't exist
```

---

## Summary: Render vs Bootstrap

| Aspect | `ztc render` | `ztc bootstrap` |
|--------|-------------|----------------|
| **Purpose** | Generate static artifacts | Execute deployment |
| **Scripts** | None execute | All execute |
| **Side Effects** | None allowed | Infrastructure changes |
| **Dynamic Values** | Not generated | Generated here |
| **Output** | Files in `platform/generated/` | Running infrastructure |
| **Idempotent** | Must be | Not required |
| **Duration** | Seconds | Minutes to hours |